<?php

$(macro :unsafe) {
    __iterator_aggregate_methods()
} >> {
    public function getIterator(): \Traversable
    {
        $<Nullable>{
            static $mask = ["\x1", "\x2", "\x4", "\x8", "\x10", "\x20", "\x40", "\x80"];
            $elementCount = $this->elementCount;
            $nullabilitySource = $this->nullabilitySource;
            $primarySource = $this->primarySource;
            $<Boolean>{
                for (
                    $byteIndex = 0, $lastByteIndex = (($elementCount + 7) >> 3) - 1;
                    $byteIndex < $lastByteIndex;
                    ++$byteIndex
                ) {
                    $primaryByte = $primarySource[$byteIndex];
                    $nullabilityByte = $nullabilitySource[$byteIndex];
                    yield ("\x0" === ($nullabilityByte & "\x01")) ? ("\x0" !== ($primaryByte & "\x01")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x02")) ? ("\x0" !== ($primaryByte & "\x02")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x04")) ? ("\x0" !== ($primaryByte & "\x04")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x08")) ? ("\x0" !== ($primaryByte & "\x08")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x10")) ? ("\x0" !== ($primaryByte & "\x10")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x20")) ? ("\x0" !== ($primaryByte & "\x20")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x40")) ? ("\x0" !== ($primaryByte & "\x40")) : null;
                    yield ("\x0" === ($nullabilityByte & "\x80")) ? ("\x0" !== ($primaryByte & "\x80")) : null;
                }
                
                if ($lastByteIndex >= 0) {
                    $primaryByte = $primarySource[$lastByteIndex];
                    $nullabilityByte = $nullabilitySource[$lastByteIndex];
                    for ($bit = 0, $bitIndex = ($lastByteIndex << 3); $bitIndex < $elementCount; ++$bitIndex, ++$bit) {
                        yield ("\x0" === ($nullabilityByte & $mask[$bit])) ? ("\x0" !== ($primaryByte & $mask[$bit])): null;
                    }
                }
            }
            $<Integer>{
                $bitIndex = 0;
                $nullabilityByte = null;
                $$(expand(
                    $<Signed>{
                        foreach ($$(expand(
                            $<Takes1>{\unpack('c*', $primarySource)}
                            $<Takes2>{\unpack('s*', $primarySource)}
                            $<Takes3>{\unpack('V*', \chunk_split($primarySource, 3, "\0")."\0")}
                            $<Takes4>{\unpack('l*', $primarySource)}
                            $<Takes5>{\unpack('P*', \chunk_split($primarySource, 5, "\0\0\0")."\0\0\0")}
                            $<Takes6>{\unpack('P*', \chunk_split($primarySource, 6, "\0\0")."\0\0")}
                            $<Takes7>{\unpack('P*', \chunk_split($primarySource, 7, "\0")."\0")}
                            $<Takes8>{\unpack('q*', $primarySource)}
                        )) as $element) {
                            if (0 === ($bitIndex & 7)) {
                                $nullabilityByte = $nullabilitySource[$bitIndex >> 3];
                            }
                            yield $bitIndex => ("\x0" === ($nullabilityByte & $mask[$bitIndex & 7])) ? (
                                $<Takes1>{ $element }
                                $<Takes2>{ $element }
                                $<Takes3>{ $element > $[MaximumValue] ? $[MaximumValue] - $element : $element }
                                $<Takes4>{ $element }
                                $<Takes5>{ $element > $[MaximumValue] ? $[MaximumValue] - $element : $element }
                                $<Takes6>{ $element > $[MaximumValue] ? $[MaximumValue] - $element : $element }
                                $<Takes7>{ $element > $[MaximumValue] ? $[MaximumValue] - $element : $element }
                                $<Takes8>{ $element }
                            ) : null;
                            ++$bitIndex;
                        }
                    }
                    $<!Signed>{
                        foreach ($$(expand(
                            $<Takes1>{\unpack('C*', $primarySource)}
                            $<Takes2>{\unpack('v*', $primarySource)}
                            $<Takes3>{\unpack('V*', \chunk_split($primarySource, 3, "\0")."\0")}
                            $<Takes4>{\unpack('V*', $primarySource)}
                            $<Takes5>{\unpack('P*', \chunk_split($primarySource, 5, "\0\0\0")."\0\0\0")}
                            $<Takes6>{\unpack('P*', \chunk_split($primarySource, 6, "\0\0")."\0\0")}
                            $<Takes7>{\unpack('P*', \chunk_split($primarySource, 7, "\0")."\0")}
                        )) as $element) {
                            if (0 === ($bitIndex & 7)) {
                                $nullabilityByte = $nullabilitySource[$bitIndex >> 3];
                            }
                            yield $bitIndex => ("\x0" === ($nullabilityByte & $mask[$bitIndex & 7])) ? $element : null;
                            ++$bitIndex;
                        }
                    }
                ))
            }
            $<String>{
                for (
                    $index = 0, $lastIndex = ($elementCount & ~7);
                    $index < $lastIndex;
                ) {
                    $batchSize = \min(256, $lastIndex - $index);
                    
                    $nullabilityBatch = \substr($nullabilitySource, $index >> 3, $batchSize >> 3);
                    $<Takes1>{
                        $primaryBatch = \substr($primarySource, $index, $batchSize);
                    }
                    $<!Takes1>{
                        $primaryBatch = \str_split(
                            \substr($primarySource, $index * $[BytesPerElement], $batchSize * $[BytesPerElement]),
                            $[BytesPerElement]
                        );
                    }
                    
                    for ($batchIndex = 0; $batchIndex < $batchSize; $batchIndex += 8) {
                        $nullabilityByte = $nullabilityBatch[$batchIndex >> 3];
                        yield ("\x0" === ($nullabilityByte & "\x01")) ? $primaryBatch[$batchIndex] : null;
                        yield ("\x0" === ($nullabilityByte & "\x02")) ? $primaryBatch[$batchIndex + 1] : null;
                        yield ("\x0" === ($nullabilityByte & "\x04")) ? $primaryBatch[$batchIndex + 2] : null;
                        yield ("\x0" === ($nullabilityByte & "\x08")) ? $primaryBatch[$batchIndex + 3] : null;
                        yield ("\x0" === ($nullabilityByte & "\x10")) ? $primaryBatch[$batchIndex + 4] : null;
                        yield ("\x0" === ($nullabilityByte & "\x20")) ? $primaryBatch[$batchIndex + 5] : null;
                        yield ("\x0" === ($nullabilityByte & "\x40")) ? $primaryBatch[$batchIndex + 6] : null;
                        yield ("\x0" === ($nullabilityByte & "\x80")) ? $primaryBatch[$batchIndex + 7] : null;
                    }
                    $index += $batchSize;
                }
                
                for (; $index < $elementCount; ++$index) {
                    if ("\0" === ($nullabilitySource[$index >> 3] & $mask[$index & 7])) {
                        $<Takes1>{
                            yield $primarySource[$index];
                        }
                        $<!Takes1>{
                            yield \substr($primarySource, $index * $[BytesPerElement], $[BytesPerElement]);
                        }
                    } else {
                        yield;
                    }
                }
            }
        }
        $<!Nullable>{
            $<Boolean>{
                static $mask = ["\x1", "\x2", "\x4", "\x8", "\x10", "\x20", "\x40", "\x80"];
                
                $elementCount = $this->elementCount;
                $primarySource = $this->primarySource;
                for (
                    $byteIndex = 0, $lastByteIndex = (($elementCount + 7) >> 3) - 1;
                    $byteIndex < $lastByteIndex;
                    ++$byteIndex
                ) {
                    $byte = $primarySource[$byteIndex];
                    yield "\x0" !== ($byte & "\x01");
                    yield "\x0" !== ($byte & "\x02");
                    yield "\x0" !== ($byte & "\x04");
                    yield "\x0" !== ($byte & "\x08");
                    yield "\x0" !== ($byte & "\x10");
                    yield "\x0" !== ($byte & "\x20");
                    yield "\x0" !== ($byte & "\x40");
                    yield "\x0" !== ($byte & "\x80");
                }
                
                if ($lastByteIndex >= 0) {
                    for ($bit = 0, $byte = $primarySource[$lastByteIndex], $bitIndex = ($lastByteIndex << 3); $bitIndex < $elementCount; ++$bitIndex, ++$bit) {
                        yield "\x0" !== ($byte & $mask[$bit]);
                    }
                }
            }
            $<Integer>{
                $<Takes1>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('c*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('C*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes2>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('s*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('v*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes3>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('V*', \chunk_split($this->primarySource, 3, "\0")."\0") as $element) {
                                yield $element > $[MaximumValue] ? $[MaximumValue] - $element : $element; 
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('V*', \chunk_split($this->primarySource, 3, "\0")."\0") as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes4>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('l*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('V*', $this->primarySource) as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes5>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 5, "\0\0\0")."\0\0\0") as $element) {
                                yield $element > $[MaximumValue] ? $[MaximumValue] - $element : $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 5, "\0\0\0")."\0\0\0") as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes6>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 6, "\0\0")."\0\0") as $element) {
                                yield $element > $[MaximumValue] ? $[MaximumValue] - $element : $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 6, "\0\0")."\0\0") as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes7>{
                    $$(expand(
                        $<Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 7, "\0")."\0") as $element) {
                                yield $element > $[MaximumValue] ? $[MaximumValue] - $element : $element;
                            }
                        }
                        $<!Signed>{
                            foreach (\unpack('P*', \chunk_split($this->primarySource, 7, "\0")."\0") as $element) {
                                yield $element;
                            }
                        }
                    ))
                }
                $<Takes8>{
                    foreach (\unpack('q*', $this->primarySource) as $element) {
                        yield $element;
                    }
                }
            }
            $<String>{
                $elementCount = $this->elementCount;
                $primarySource = $this->primarySource;
                
                $<Takes1>{
                    for ($i = 0; $i < $elementCount; ++$i) {
                        yield $primarySource[$i];
                    }
                }
                $<!Takes1>{
                    $batchSize = 256 * $[BytesPerElement];
                    for ($index = 0; $index < $elementCount; $index += 256) {
                        yield from \array_combine(
                            \range($index, \min($elementCount, $index + 256) - 1),
                            (array) \str_split(\substr($primarySource, $index * $[BytesPerElement], $batchSize), $[BytesPerElement])
                        );
                    }
                }
            }
        }
    }
}
